{% extends "base.html" %}

{% block title %}Synexs - Statistics{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="total-attacks">0</div>
        <div class="stat-label">Total Attacks</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="unique-ips">0</div>
        <div class="stat-label">Unique IPs</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
        <div class="card-header">Attacks per Hour (Last 24h)</div>
        <div class="chart-container">
            <canvas id="hourly-chart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Top Countries</div>
        <div class="chart-container">
            <canvas id="country-chart"></canvas>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    <div class="card">
        <div class="card-header">Top CVEs</div>
        <table id="cve-table">
            <thead>
                <tr>
                    <th>CVE</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody id="cve-tbody">
                <tr><td colspan="2" class="loading">Loading</td></tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">Recent Attacks</div>
        <table id="recent-table">
            <thead>
                <tr>
                    <th>IP</th>
                    <th>Country</th>
                    <th>CVEs</th>
                </tr>
            </thead>
            <tbody id="recent-tbody">
                <tr><td colspan="3" class="loading">Loading</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let hourlyChart, countryChart;

    async function loadStats() {
        try {
            const response = await fetch('/api/stats-summary');
            const data = await response.json();

            // Update summary stats
            document.getElementById('total-attacks').textContent = data.total_attacks.toLocaleString();
            document.getElementById('unique-ips').textContent = data.unique_ips.toLocaleString();

            // Hourly chart
            const hourlyLabels = data.hourly_data.map(h => {
                const date = new Date(h.hour);
                return date.getHours() + ':00';
            });
            const hourlyCounts = data.hourly_data.map(h => h.count);

            if (hourlyChart) hourlyChart.destroy();
            hourlyChart = new Chart(document.getElementById('hourly-chart'), {
                type: 'line',
                data: {
                    labels: hourlyLabels,
                    datasets: [{
                        label: 'Attacks',
                        data: hourlyCounts,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#00ff41' },
                            grid: { color: 'rgba(0, 255, 65, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#00ff41' },
                            grid: { color: 'rgba(0, 255, 65, 0.1)' }
                        }
                    }
                }
            });

            // Country chart
            const countryLabels = data.top_countries.map(c => c.country);
            const countryCounts = data.top_countries.map(c => c.count);

            if (countryChart) countryChart.destroy();
            countryChart = new Chart(document.getElementById('country-chart'), {
                type: 'bar',
                data: {
                    labels: countryLabels,
                    datasets: [{
                        label: 'Attacks',
                        data: countryCounts,
                        backgroundColor: '#00ff41',
                        borderColor: '#00cc33',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#00ff41' },
                            grid: { color: 'rgba(0, 255, 65, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#00ff41' },
                            grid: { color: 'rgba(0, 255, 65, 0.1)' }
                        }
                    }
                }
            });

            // CVE table
            const cveTbody = document.getElementById('cve-tbody');
            cveTbody.innerHTML = data.top_cves.map(cve => `
                <tr>
                    <td>${cve.cve}</td>
                    <td>${cve.count}</td>
                </tr>
            `).join('') || '<tr><td colspan="2">No data</td></tr>';

            // Recent attacks table
            const recentTbody = document.getElementById('recent-tbody');
            recentTbody.innerHTML = data.recent_attacks.map(attack => `
                <tr>
                    <td>${attack.ip}</td>
                    <td>${attack.country || 'Unknown'}</td>
                    <td>${attack.vulns.length}</td>
                </tr>
            `).join('') || '<tr><td colspan="3">No data</td></tr>';

        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Initial load
    loadStats();

    // Auto-refresh every 10 seconds
    setInterval(loadStats, 10000);
</script>
{% endblock %}
